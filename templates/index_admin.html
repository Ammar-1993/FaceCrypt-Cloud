<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>FaceCrypt Cloud - Admin Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f8f9fa;
      padding: 20px;
    }
    h1, h3, h4 {
      text-align: center;
    }
    .card {
      margin-bottom: 20px;
    }
    #loginSection, #adminPanel {
      max-width: 600px;
      margin: auto;
    }
    .hidden {
      display: none;
    }
    .alert {
      margin-top: 10px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1 class="mb-4">‚úÖ FaceCrypt Cloud - Admin Portal</h1>

    <!-- Login Section -->
    <div id="loginSection" class="card p-4 shadow">
      <h3 class="mb-3">üîê Admin Login</h3>
      <input type="password" id="adminPassword" class="form-control mb-3" placeholder="Admin Password">
      <button class="btn btn-primary w-100" onclick="adminLogin()">Login</button>
      <div id="loginMessage"></div>
    </div>

    <!-- Admin Panel -->
    <div id="adminPanel" class="hidden">

      <div class="card p-4 shadow">
        <h4>‚ûï Add New User</h4>
        <input type="text" id="newUserId" class="form-control mb-2" placeholder="User ID">
        <input type="text" id="newUserName" class="form-control mb-2" placeholder="Name">
        <input type="email" id="newUserEmail" class="form-control mb-2" placeholder="Email">
        <input type="file" id="newUserImage" class="form-control mb-2">
        <button class="btn btn-success w-100" onclick="addUser()">Add User</button>
        <div id="addUserMessage"></div>
      </div>

      <div class="card p-4 shadow">
        <h4>‚ùå Delete User</h4>
        <select id="deleteUserId" class="form-select mb-2"></select>
        <button class="btn btn-danger w-100" onclick="deleteUser()">Delete User</button>
        <div id="deleteUserMessage"></div>
      </div>

      <div class="card p-4 shadow">
        <h4>üìú Audit Logs</h4>
        <table class="table table-striped table-bordered">
          <thead class="table-dark">
            <tr>
              <th>Event</th>
              <th>Status</th>
              <th>User ID</th>
              <th>Timestamp</th>
            </tr>
          </thead>
          <tbody id="auditLogsTable">
            <tr><td colspan="4" class="text-center">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    

// ============= Config =============
const API_BASE = 'http://127.0.0.1:8080';

// ============= Helpers =============
function show(elem) { elem.classList.remove('hidden'); }
function hide(elem) { elem.classList.add('hidden'); }
function setText(id, msg) { document.getElementById(id).innerHTML = msg; }

// ============= Admin Login =============
async function adminLogin() {
  const password = document.getElementById('adminPassword').value;
  const res = await fetch(`${API_BASE}/admin/login`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password })
  });
  const data = await res.json();
  if (res.ok) {
    setText('loginMessage', `<span class="text-success">‚úÖ ${data.message}</span>`);
    hide(document.getElementById('loginSection'));
    show(document.getElementById('adminPanel'));
    await loadUsers();
    await fetchAuditLogs();
  } else {
    setText('loginMessage', `<span class="text-danger">‚ùå ${data.error}</span>`);
  }
}

// ============= Add User =============
async function addUser() {
  const userId = document.getElementById('newUserId').value;
  const name = document.getElementById('newUserName').value;
  const email = document.getElementById('newUserEmail').value;
  const image = document.getElementById('newUserImage').files[0];

  if (!userId || !name || !email || !image) {
    setText('addUserMessage', `<span class="text-danger">‚ùå Please fill all fields and choose an image.</span>`);
    return;
  }

  const formData = new FormData();
  formData.append('user_id', userId);
  formData.append('name', name);
  formData.append('email', email);
  formData.append('image', image);

  const res = await fetch(`${API_BASE}/admin/add_user`, { method: 'POST', body: formData });
  const data = await res.json();
  if (res.ok) {
    setText('addUserMessage', `<span class="text-success">‚úÖ ${data.message}</span>`);
    await loadUsers();
  } else {
    setText('addUserMessage', `<span class="text-danger">‚ùå ${data.error}</span>`);
  }
}

// ============= Load Users for Deletion =============
async function loadUsers() {
  const select = document.getElementById('deleteUserId');
  select.innerHTML = '';
  const res = await fetch(`${API_BASE}/admin/list_users`);
  const data = await res.json();

  data.users.forEach(user => {
    const option = document.createElement('option');
    option.value = user.id;
    option.text = `${user.name} (${user.id})`;
    select.add(option);
  });
}

// ============= Delete User =============
async function deleteUser() {
  const userId = document.getElementById('deleteUserId').value;
  if (!userId) {
    setText('deleteUserMessage', `<span class="text-danger">‚ùå Please select a user to delete.</span>`);
    return;
  }

  const res = await fetch(`${API_BASE}/admin/delete_user`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ user_id: userId })
  });

  const data = await res.json();
  if (res.ok) {
    setText('deleteUserMessage', `<span class="text-success">‚úÖ ${data.message}</span>`);
    await loadUsers();
  } else {
    setText('deleteUserMessage', `<span class="text-danger">‚ùå ${data.error}</span>`);
  }
}

// ============= Fetch Audit Logs =============
async function fetchAuditLogs() {
  const table = document.getElementById('auditLogsTable');
  table.innerHTML = '<tr><td colspan="4" class="text-center">Loading...</td></tr>';

  const res = await fetch(`${API_BASE}/admin/audit_logs`);
  const data = await res.json();

  if (data.logs.length === 0) {
    table.innerHTML = '<tr><td colspan="4" class="text-center">No logs found.</td></tr>';
    return;
  }

  table.innerHTML = '';
  data.logs.forEach(log => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td>${log.event || ''}</td>
      <td>${log.status || ''}</td>
      <td>${log.user_id || ''}</td>
      <td>${log.timestamp || ''}</td>
    `;
    table.appendChild(row);
  });
}

function showAlert(elementId, message, type) {
      document.getElementById(elementId).innerHTML = `
        <div class="alert alert-${type}" role="alert">
          ${message}
        </div>`;
    }

  </script>

</body>
</html>
